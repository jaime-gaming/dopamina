<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>DOPAMINA</title>
<style>
html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#111;font-family:Arial;color:white;cursor:none;} /* Hide system cursor; custom cursor is used. */
*{cursor:none !important;} /* Ensure system cursor is hidden on all elements */
#loader{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;background:black;color:white;font-size:50px;z-index:9999;display:none; }
#loader span{font-size:22px;animation:blink 1s infinite;}
#version{position:absolute;bottom:10px;right:10px;font-size:16px;color:#fff;}
@keyframes blink{0%,50%{opacity:1;}51%,100%{opacity:0;}}
.rainbow-bg{animation:rainbow 6s linear infinite;background:linear-gradient(120deg,red,orange,yellow,green,cyan,blue,purple);background-size:300% 300%;}
@keyframes rainbow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%;}}
#stats{position:fixed;top:10px;left:15px;z-index:900;font-size:22px;line-height:30px;text-shadow:0 0 5px black;display:flex;flex-direction:column;gap:5px;transition:0.3s;}
#stats.gameTab{font-size:32px;}
#tabs{display:flex;justify-content:center;align-items:center;margin-top:60px;} 
.tabBtn{background:#333;color:white;border:none;padding:10px 15px;margin:0 10px;cursor:pointer;border-radius:5px;font-size:20px;transition:0.3s;}
.tabBtn:hover{transform:scale(1.05);}
#tabLabel{font-size:25px;margin:0 20px;transition:0.3s;}
.tabContent{display:none;position:absolute;top:130px;left:0;width:100%;height:calc(100% - 130px);overflow-y:auto;text-align:center;transition:opacity 0.5s ease;}
#clickIcon{width:250px;height:250px;border-radius:50%;background:#ff4081;box-shadow:0 0 50px #ff4081;cursor:pointer;margin:auto;margin-top:120px;transition:transform 0.15s,box-shadow 0.15s,background 0.15s;}
#clickIcon:hover{transform:scale(1.1);box-shadow:0 0 70px #ff80ab;}
#clickIcon:active{transform:scale(0.92);}

@keyframes spin{100%{transform:rotate(360deg);}}
.particle{position:absolute;width:20px;height:20px;border-radius:50%;pointer-events:none;animation:pop 0.8s ease-out forwards;}
@keyframes pop{0%{opacity:1;transform:scale(1);}100%{opacity:0;transform:scale(0.1) translate(var(--tx),var(--ty));}}
/* Burn particle for fireball continuous effect */
.particle.burn{width:10px;height:10px;animation:burnMove 900ms linear forwards;filter:blur(0.4px);box-shadow:0 0 6px rgba(255,120,30,0.5);}
@keyframes burnMove{0%{opacity:1;transform:translate(0,0) scale(1) rotate(0);}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0.6) rotate(12deg);}}
/* Trail particle for launched fireball (elongated streaks) */
.particle.trail{width:18px;height:6px;border-radius:6px;pointer-events:none;background:linear-gradient(90deg,#ffb74d,#ff6e40);transform-origin:center;animation:trailMove 900ms linear forwards;}
@keyframes trailMove{0%{opacity:1;transform:translate(0,0) scaleX(1);}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scaleX(0.1);}}
/* Absorb particle for blackhole click effect */
.particle.absorb{width:10px;height:10px;background:radial-gradient(circle at 30% 30%, #666, #000);animation:absorbMove 900ms linear forwards;box-shadow:0 0 6px rgba(0,0,0,0.6);}
@keyframes absorbMove{0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0.2);}}

/* Custom cursor */
#customCursor{position:fixed;width:26px;height:26px;border-radius:50%;border:2px solid #fff;transform:translate(-50%,-50%);pointer-events:none;z-index:20000;mix-blend-mode:screen;transition:transform 80ms linear,opacity 120ms;display:block}
#customCursor .inner{position:absolute;inset:6px;border-radius:50%;background:rgba(255,255,255,0.12);}
#customCursor.pulse{transform:translate(-50%,-50%) scale(1.6);opacity:0.9}
#customCursor.spark{box-shadow:0 0 14px rgba(255,150,20,0.8);}

/* Click contraction animation: contracts then returns to normal */
#customCursor.contract{animation:cursorContract 260ms cubic-bezier(.2,.8,.2,1) forwards}
@keyframes cursorContract{0%{transform:translate(-50%,-50%) scale(1);}40%{transform:translate(-50%,-50%) scale(0.56);}100%{transform:translate(-50%,-50%) scale(1);}}
#customCursor.contract .inner{transition:transform 160ms cubic-bezier(.2,.8,.2,1); transform:scale(0.85);}
@keyframes cursorPulse{0%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.05);}100%{transform:translate(-50%,-50%) scale(1);}}
.storeGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;padding:10px;}
.upgItem{background:#222;border:1px solid #444;padding:10px;border-radius:6px;display:flex;flex-direction:column;align-items:center;}
.upgHeader{font-size:20px;margin-bottom:5px;}
.buyBtn{background:#2196f3;border:none;color:white;padding:8px 15px;border-radius:5px;cursor:pointer;font-size:16px;transition:background 0.2s, transform 0.2s;}
.buyBtn:hover{background:#1e88e5;transform:scale(1.06);}
/* Locked buttons should not appear blocked: keep same appearance and cursor */
.buyBtn.locked{background:#2196f3;opacity:1;cursor:pointer;pointer-events:auto;}
.buyBtn.success{background:#4caf50 !important;}
.buyBtn.fail{background:#f44336 !important;}
.discount{color:#ff0;margin-left:5px;font-weight:bold;} /* Skins (cosm√©ticos para el c√≠rculo de puntos) */
.skinItem{background:#222;border:1px solid #444;padding:8px;border-radius:8px;display:flex;flex-direction:column;align-items:center;width:150px;gap:6px}
.skinPreview{width:60px;height:60px;border-radius:50%;margin-bottom:6px;box-shadow:0 0 8px rgba(0,0,0,0.6);}
.skinItem small{font-size:12px;color:#ccc}#levelTab h2{margin-top:20px;font-size:40px;} 
#expBarWrapper{width:70%;margin:auto;background:#333;height:30px;border-radius:15px;margin-top:20px;position:relative;}
#expBar{background:#ff4081;height:100%;width:0%;border-radius:15px;transition:width 0.3s;}
#expText{position:absolute;width:100%;top:0;left:0;text-align:center;line-height:30px;font-size:16px;}
#critText{position:absolute;color:#ff0;font-size:24px;font-weight:bold;text-shadow:0 0 8px black;pointer-events:none;animation:critAnim 0.8s forwards;display:none;}
@keyframes critAnim{0%{opacity:1;transform:translateY(0);}100%{opacity:0;transform:translateY(-50px);}}
#settingsIcon{position:fixed;top:10px;right:15px;width:40px;height:40px;background:#333;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;z-index:950;font-size:24px;transition:0.3s;}
#settingsIcon:hover{transform:scale(1.2);background:#444;}
#settingsModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:1000;}
#settingsContent{background:#222;border:2px solid #444;border-radius:10px;padding:20px;display:flex;flex-direction:column;align-items:center;gap:15px;min-width:300px;}
/* Skins Button (hanger) */
#skinsBtn{position:fixed;top:60px;right:15px;width:40px;height:40px;background:#333;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;z-index:950;font-size:22px;transition:0.3s}
#skinsBtn:hover{transform:scale(1.2);background:#444}

/* Skins tab index boxes */
.skinIndexBox{width:180px;height:180px;border-radius:14px;background:#111;border:2px solid #444;display:flex;flex-direction:column;justify-content:center;align-items:center;font-size:14px;color:white;cursor:pointer;user-select:none;padding:8px}
.skinIndexBox .previewInner{width:100%;height:100%;border-radius:50%;display:block;background-size:cover;background-position:center;overflow:hidden}
.skinIndexBox.selected{border-color:#1e88e5;box-shadow:0 0 10px #1e88e5}
.skinDetailPreview{width:140px;height:140px;border-radius:50%;margin:auto;box-shadow:0 0 30px rgba(0,0,0,0.6);} 
.comingSoon{width:80px;height:80px;border-radius:50%;background:#222;border:2px dashed #666;display:flex;justify-content:center;align-items:center;color:#ccc}
@keyframes deform{0%{border-radius:50% 50% 50% 50%;transform:scale(1);}50%{border-radius:40% 60% 50% 50%;transform:scale(0.95);}100%{border-radius:50% 50% 50% 50%;transform:scale(1);}}
.comingSoon .deformer{width:48px;height:48px;background:#333;border-radius:50%;display:block;box-shadow:0 0 10px rgba(255,255,255,0.05)}
.deformer.play{animation:deform 1s ease-in-out;} 
#closeSettingsBtn{cursor:pointer;font-size:24px;position:absolute;top:10px;right:10px;}
#settingsContent button{background:#2196f3;border:none;color:white;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:16px;}
#settingsContent button:hover{background:#1e88e5;transform:scale(1.05);}
#popupContainer{position:fixed;top:10px;right:10px;z-index:1001;display:flex;flex-direction:column;gap:5px;}
.popup{background:#222;border:2px solid #444;padding:12px 16px;border-radius:8px;font-size:18px;color:white;pointer-events:auto;opacity:0;transition:opacity 0.35s, transform 0.35s;transform:translateX(20px);margin-bottom:6px;}
.popup.show{opacity:1;transform:translateX(0);} 

/* Daily Calendar floating button and panel */
#dailyCalendarBtn{position:fixed;bottom:15px;left:15px;width:48px;height:48px;border-radius:10px;background:#333;color:white;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 10px rgba(0,0,0,0.6);cursor:pointer;z-index:1002;font-size:22px}
#dailyCalendarBtn .flame{position:absolute;left:50%;bottom:54px;transform:translateX(-50%);width:12px;height:18px;border-radius:50% 50% 40% 40%;background:radial-gradient(circle at 50% 30%, #fff 0%, #ffeb3b 20%, #ff8c00 50%, #d84315 80%);opacity:0;pointer-events:none;filter:blur(0.2px);transform-origin:center}
#dailyCalendarBtn.fireAnim .flame{opacity:1;animation:flameBurst 1000ms ease-out forwards}
@keyframes flameBurst{0%{transform:translateX(-50%) translateY(0) scale(0.6);opacity:0.9}40%{transform:translateX(-50%) translateY(-8px) scale(1.2);opacity:1}100%{transform:translateX(-50%) translateY(-28px) scale(0.8);opacity:0}}
#dailyCalendarBtn:hover{transform:scale(1.06);background:#444}
#dailyCalendar{position:fixed;bottom:75px;left:15px;width:320px;background:#222;border:2px solid #444;padding:12px;border-radius:8px;z-index:1002;display:none}
#dailyCalendar #calendarHeader{font-weight:bold;margin-bottom:6px;text-align:center}
#dailyCalendar .calendarGrid{display:grid;grid-template-columns:repeat(7,40px);gap:6px;justify-content:center;margin-top:8px}
#dailyCalendar .dayCell{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#222;border:1px solid #444;border-radius:6px;color:#ccc}
#dailyCalendar .dayCell.claimed{background:#2e7d32;color:#fff;border-color:#2e7d32}
#dailyCalendar .dayCell.today{box-shadow:0 0 8px #ff4081;border-color:#ff4081}
#dailyCalendar #claimTodayBtn{margin-top:6px}

/* Spark (fire) particles */
.spark{position:absolute;border-radius:2px;opacity:1;transform-origin:center;animation:sparkRise 700ms linear forwards;z-index:1003}
@keyframes sparkRise{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(-80px) rotate(360deg);opacity:0}}
/* Claim animations */
.claimedAnim{animation:claimBurst 800ms ease-out forwards}
@keyframes claimBurst{0%{transform:scale(1);opacity:1}50%{transform:scale(1.18);opacity:1}100%{transform:scale(1);opacity:0.9;transform:translateY(-24px) scale(0.8);} }
.streakPulse{animation:pulse 700ms ease-out}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
.dayCell.claimedAnim{animation:popClaim 900ms ease-out forwards}
@keyframes popClaim{0%{transform:scale(0.8);opacity:0}50%{transform:scale(1.12);opacity:1}100%{transform:scale(1);opacity:1}}
/* Confetti */
.confetti{position:absolute;border-radius:2px;opacity:1;transform-origin:center;animation:confettiFall 900ms linear forwards;z-index:1003}
@keyframes confettiFall{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(140px) rotate(720deg);opacity:0}}
 
.statAnim{animation:statZoom 0.3s forwards;}
@keyframes statZoom{0%{transform:scale(1);}50%{transform:scale(1.3);}100%{transform:scale(1);}}
/* Daily Calendar styles */
.calendarGrid{display:grid;grid-template-columns:repeat(7,40px);gap:6px;justify-content:center;margin-top:8px}
.dayCell{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#222;border:1px solid #444;border-radius:6px;color:#ccc}
.dayCell.claimed{background:#2e7d32;color:#fff;border-color:#2e7d32}
.dayCell.today{box-shadow:0 0 8px #ff4081;border-color:#ff4081}
#calendarHeader{font-weight:bold;margin-bottom:6px;text-align:center}
#dailyCalendar{display:none;margin-top:8px}
#claimTodayBtn{margin-top:6px}

/* Stock table removed */

</style>
</head>
<body>
<div id="loader" class="rainbow-bg">DOPAMINA<span>Generando placer...</span><div id="version">b0.43</div></div> 

<div id="stats"><div id="counter">0</div><div id="pps">PXS: 0</div><div id="levelStat">Nivel: 1</div></div>
<div id="settingsIcon">‚öôÔ∏è</div>
<div id="skinsBtn">üé©</div>
<div id="tabs"><button class="tabBtn" id="prevTab">&lt;</button><span id="tabLabel">Juego</span><button class="tabBtn" id="nextTab">&gt;</button></div>

<div id="gameTab" class="tabContent"><div id="clickIcon"></div></div>
<div id="storeTab" class="tabContent"><h2>Tienda</h2><div class="storeGrid" id="storeGrid"></div>
</div>
<div id="skinsTab" class="tabContent"><h2>Skins</h2>
  <div id="skinsIndex" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:18px"></div>
  <div id="skinDetail" style="margin-top:18px;text-align:center;min-height:120px"></div>
</div>
<div id="levelTab" class="tabContent"><h2>Nivel <span id="levelNum">1</span></h2> 
<div id="expBarWrapper"><div id="expBar"></div><div id="expText"></div></div>
</div>

<div id="critText">CR√çTICO!</div>

<div id="settingsModal"><div id="settingsContent">
<div id="closeSettingsBtn">‚ùå</div>
<button id="downloadSaveBtn">Descargar Guardado</button>
<div id="legacySaveHint" style="display:none;color:#ffcc00;margin-top:8px;font-size:12px;">Has cargado un archivo antiguo. Descarga como <code>.dopamina</code> para seguir guardando.</div>
<input type="file" id="loadSaveInput" accept=".dopamina,application/json" style="display:none;">
<button id="loadSaveBtn">Cargar Guardado</button>
<label><input type="checkbox" id="performanceToggle"> Modo Rendimiento</label> 





</div></div> 

<div id="popupContainer"></div>
<div id="customCursor"><div class="inner"></div></div>

<!-- Floating Daily Calendar Button and Panel -->
<div id="dailyCalendarBtn" title="Calendario diario">üìÖ<div class="flame"></div></div>
<div id="dailyCalendar" aria-hidden="true">
  <div id="calendarHeader">Racha: <span id="calendarStreak">0</span> d√≠as</div>
  <div id="calendarGrid" class="calendarGrid"></div>
  <div style="margin-top:8px;text-align:center;"><button id="claimTodayBtn" class="buyBtn">Reclamar hoy</button></div>
  <small id="calendarNote">Reclama una vez por d√≠a. Mant√©n racha para mejores recompensas.</small>
</div> 

<script>
// ===================== VARIABLES =====================
let puntos=0,incremento=1,autoClicks=0,multiplicadorTemporal=1,dopaActivo=false,nivel=1,experiencia=0,xpMult=1,critChance=0; /* Crits disabled until purchased */;
let performanceMode=false;
const xpTarget=[0,400,1350,3200,6250,10800,17150,25600,36450,50000,66550,86400,109850,137200,168750,204800,245650,291600,343000,400000];
// Deformer interval id needs to be declared early to avoid TDZ when renderSkinsTab calls startDeformer
let deformerIntervalId = null;
let skinsTimerIntervalId = null;
let fireballEffectId = null; // interval for continuous burn effect
let loadedFromOldFormat = false; // set true when a legacy save is loaded

// Ensure loader shows immediately on startup (defensive, in case other code errors)
try{
  const loaderEl = document.getElementById('loader');
  if(loaderEl){ loaderEl.style.display='flex'; setTimeout(()=>{loaderEl.style.display='none';},2000); }
}catch(e){console.error('Loader init error',e);}


const storeItems=[
{id:"u1",name:"+1 por clic",desc:"Aumenta puntos por clic",cost:50,func:()=>incremento++,unlocked:true,once:false,multi:true},
{id:"u2",name:"Auto-click +1/s",desc:"Genera puntos autom√°ticamente",cost:100,func:()=>autoClicks++,unlocked:true,once:false,multi:true},
{id:"u3",name:"Clicks cr√≠ticos",desc:"Probabilidad de cr√≠tico x2",cost:500,func:()=>{critChance+=0.1;},unlocked:true,once:true}
];

// ===================== SKINS (cosm√©ticos) =====================
const skins=[
  {id:'default',name:'Principal',desc:'Apariencia original',style:{background:'#ff4081',border:'none',boxShadow:'0 0 50px #ff4081'},cost:0},
  {id:'blackhole',name:'Agujero Negro',desc:'Interior negro con borde blanca',style:{background:'#000',border:'4px solid #fff',boxShadow:'0 0 20px #000, 0 0 8px #fff',preventColorChange:true},cost:100000},
  {id:'fireball',name:'Bola de Fuego',desc:'Bola ardiente con part√≠culas de fuego. Creada por AdriXD',style:{background:'radial-gradient(circle at 30% 30%, #ff8c00, #ff4500, #8b0000)',border:'4px solid #ff8c00',boxShadow:'0 0 30px #ff8c00',preventColorChange:true},cost:0,unlock:{playTime:3600}}
];
let ownedSkins=['default'];
let selectedSkin='default';

// Gameplay tracking
let playTimeSeconds=0; // total play time in seconds
let consecutiveClicks=0;
let lastClickTime=0; // ms timestamp



/* Fruits and farms removed ‚Äî feature deprecated */


let tabs=["gameTab","storeTab","levelTab"],tabIndex=0;

// ===================== TAB CONTROL =====================
function showTab(){/* ensure skins tab is hidden when navigating with arrows */document.getElementById('skinsTab').style.display='none';tabs.forEach((t,i)=>{let el=document.getElementById(t);el.style.display=i===tabIndex?"block":"none";el.style.opacity=0;if(i===tabIndex)setTimeout(()=>el.style.opacity=1,10);});document.getElementById("tabLabel").textContent=["Juego","Tienda","Nivel"][tabIndex];document.getElementById("stats").classList.toggle("gameTab",tabIndex===0); // manage skin effects when switching tabs
  if(tabIndex!==0){ stopFireballEffect(); } else { if(selectedSkin==='fireball'){ startFireballEffect(); } } } 
document.getElementById("prevTab").onclick=()=>{tabIndex=(tabIndex-1+tabs.length)%tabs.length;showTab();}
document.getElementById("nextTab").onclick=()=>{tabIndex=(tabIndex+1)%tabs.length;showTab();}
document.addEventListener("keydown",e=>{if(e.key==="ArrowLeft"){tabIndex=(tabIndex-1+tabs.length)%tabs.length;showTab();}if(e.key==="ArrowRight"){tabIndex=(tabIndex+1)%tabs.length;showTab();}});
showTab();

// ===================== ACTUALIZACION =====================
function update(){document.getElementById("counter").textContent=Math.floor(puntos);document.getElementById("pps").textContent=`PXS: ${Math.floor(autoClicks*multiplicadorTemporal)}`;document.getElementById("levelStat").textContent="Nivel: "+nivel; updateLevel();}
function statAnim(el){if(!performanceMode){el.classList.add("statAnim");setTimeout(()=>el.classList.remove("statAnim"),300);}}

// ===================== CLIC PRINCIPAL =====================
document.getElementById("clickIcon").onclick=e=>{
    let gain=incremento*multiplicadorTemporal;
    puntos+=gain;experiencia+=gain*xpMult;
    // consecutive clicks (reset if more than 1.5s between clicks)
    const now=Date.now();
    if(now - lastClickTime <= 1500){consecutiveClicks++;}else{consecutiveClicks=1;} lastClickTime=now;
    // Ensure skins explicitly marked to prevent color change (fireball, blackhole) never get randomized backgrounds
    let currentSkin = skins.find(s=>s.id===selectedSkin);
    const noColorChange = (currentSkin && currentSkin.preventColorChange) || selectedSkin === 'fireball' || selectedSkin === 'blackhole';
    const el = document.getElementById("clickIcon");
    if(noColorChange){
        if(el) applySkin(); // re-apply definitive skin styles
        console.warn && console.warn('Color change prevented for skin', selectedSkin);
    } else {
        let newBg = `hsl(${Math.random()*360},100%,60%)`;
        if(el){ el.style.background = newBg; el.style.boxShadow = `0 0 50px ${newBg}`; }
        // in case a protected skin becomes selected right after, re-apply it after the transient color
        setTimeout(()=>{ let cur = skins.find(s=>s.id===selectedSkin); if(cur && cur.preventColorChange){ applySkin(); console.warn && console.warn('Re-applied protected skin after color change attempt', selectedSkin); } }, 220);
    }
    // special handling for skins
if(selectedSkin==='blackhole' && !performanceMode){ // absorb click particles (smaller burst)
        spawnAbsorbParticles(18,e.clientX,e.clientY); for(let i=0;i<4;i++){ spawnAbsorbParticles(4,e.clientX + (Math.random()-0.5)*40, e.clientY + (Math.random()-0.5)*40); }
    } else if(selectedSkin==='fireball' && !performanceMode){ const elF = document.getElementById('clickIcon'); if(elF){ const r = elF.getBoundingClientRect(); const cx = r.left + r.width/2; const cy = r.top + r.height/2; // sparks around bottom of the circle
        spawnFireParticles(24, cx, cy + r.height*0.28); // burn puffs originate from bottom of circle and move upward
        for(let i=0;i<6;i++){ let px = cx + (Math.random()-0.5)*(r.width*0.5); let py = cy + r.height*0.35 + (Math.random()*8); spawnBurnParticle(px,py,true); }
        // launch-trail in the direction from center to click (simulate thrown launch)
        const dx = e.clientX - cx; const dy = e.clientY - cy; spawnLaunchTrail(cx,cy,dx,dy,16); } 
    }
    else if(selectedSkin==='default' && !performanceMode){ spawnParticles(30,e.clientX,e.clientY); }
    spawnCrit(e.clientX,e.clientY);
    update(); checkLevel();
};
function spawnParticles(n,x,y){for(let i=0;i<n;i++){let p=document.createElement("div");p.className="particle";p.style.left=x+"px";p.style.top=y+"px";p.style.background=`hsl(${Math.random()*360},100%,60%)`;p.style.setProperty("--tx",(Math.random()-0.5)*200+"px");p.style.setProperty("--ty",(Math.random()-0.5)*200+"px");document.body.appendChild(p);setTimeout(()=>p.remove(),800);}}
function spawnCrit(x,y){if(Math.random()<critChance){let crit=document.getElementById("critText");crit.style.left=x+"px";crit.style.top=y+"px";crit.style.display="block";crit.style.opacity=1;crit.style.transform="translateY(0)";setTimeout(()=>{crit.style.display="none";},800);}}

function spawnFireParticles(n,x,y){ if(!isFinite(x) || !isFinite(y) || x < -50 || y < -50 || x > window.innerWidth+50 || y > window.innerHeight+50) return; for(let i=0;i<n;i++){let p=document.createElement("div");p.className="particle";p.style.left=(x + (Math.random()-0.5)*80)+"px";p.style.top=(y + (Math.random()-0.5)*80)+"px";p.style.background=`radial-gradient(circle at 30% 30%, #fff3e0, #ff9800 30%, #d84315 70%)`; let size = 6 + Math.random()*6; p.style.width = size + "px"; p.style.height = size + "px"; p.style.borderRadius="50%";p.style.opacity=1; // diagonal-ish movement
    let tx = ((Math.random()*0.6)+0.2) * (Math.random()<0.5 ? -1 : 1) * 50; let ty = tx * 0.6; // correlated to make diagonal streaks
    p.style.setProperty("--tx",tx+"px");p.style.setProperty("--ty",ty+"px");p.style.filter="blur(0.5px)";document.body.appendChild(p);setTimeout(()=>{try{p.remove()}catch(_e){}},1100);} }

// ===================== TIENDA =====================
function renderStore(){let container=document.getElementById("storeGrid");container.innerHTML="";storeItems.filter(it=>!it.purchased).sort((a,b)=>a.cost-b.cost).forEach(item=>{let div=document.createElement("div");div.className="upgItem";let header=document.createElement("div");header.className="upgHeader";header.textContent=item.name;let desc=document.createElement("p");desc.textContent=item.desc;let btn=document.createElement("button");btn.className="buyBtn";btn.textContent=`Comprar (${item.cost})`;btn.dataset.itemId = item.id;btn.onclick=(e)=>{ e.stopPropagation(); btn.dataset.handled='1'; setTimeout(()=>{ try{ delete btn.dataset.handled; }catch(_e){} },1100); if(puntos>=item.cost){puntos-=item.cost;item.func(); if(item.once){ item.purchased=true; } update();if(item.multi) item.cost = Math.floor(item.cost*1.25);btn.classList.add('success');setTimeout(()=>{btn.classList.remove('success');renderStore();},1000); } else { btn.classList.add('fail');showPopup('Fondos insuficientes');setTimeout(()=>{btn.classList.remove('fail');renderStore();},1000);} }; div.appendChild(header);div.appendChild(desc);div.appendChild(btn);container.appendChild(div);});
}

// Delegated backup handler (resilient if closures fail)
const grid=document.getElementById('storeGrid');
if(grid && !grid._delegated){
  grid._delegated=true;
  grid.addEventListener('click',e=>{
    let btn=e.target.closest('button.buyBtn'); if(!btn) return; if(btn.dataset && btn.dataset.handled==='1') return; let id=btn.dataset.itemId; let item=storeItems.find(it=>it.id===id); if(!item) return;
    if(puntos>=item.cost){ puntos-=item.cost; item.func(); if(item.once){ item.purchased=true; } update(); if(item.multi) item.cost = Math.floor(item.cost*1.25); btn.classList.add('success'); setTimeout(()=>{btn.classList.remove('success'); renderStore();},1000); } else { btn.classList.add('fail'); showPopup('Fondos insuficientes'); setTimeout(()=>{btn.classList.remove('fail'); renderStore();},1000); }
  });
}

renderStore(); update(); updateLevel(); renderSkinsTab(); applySkin();

// ===================== SKIN FUNCTIONS (rendered in Store) =====================
function applySkin(){let el=document.getElementById('clickIcon');let skin=skins.find(s=>s.id===selectedSkin);if(!skin)return;el.style.background=skin.style.background||'#ff4081';el.style.border=skin.style.border||'none';el.style.boxShadow=skin.style.boxShadow||'0 0 50px #ff4081';
  // manage continuous fire effect
  if(selectedSkin==='fireball'){ startFireballEffect(); } else { stopFireballEffect(); }}

function startFireballEffect(){try{ // only start effect if we are on the Game tab (avoid creating invisible particles on other tabs)
    if(tabIndex!==0) return; stopFireballEffect(); const el = document.getElementById('clickIcon'); if(!el) return; fireballEffectId = setInterval(()=>{ const r = el.getBoundingClientRect(); // only spawn if icon is visible and we are on the Game tab
    if(tabIndex!==0 || r.width<=0 || r.height<=0) return; const cx = r.left + r.width/2; const cy = r.top + r.height/2; // spawn burn puffs from bottom of circle
    const offsets = [{x:0,y:r.height*0.38},{x:-r.width*0.25,y:r.height*0.32},{x:r.width*0.25,y:r.height*0.32}]; offsets.forEach(off=>{ for(let i=0;i<1;i++){ let px = cx + off.x + (Math.random()-0.5)*10; let py = cy + off.y + (Math.random()-0.5)*8; spawnBurnParticle(px,py); } });
    // occasionally spawn a longer launch trail to simulate motion
    if(Math.random()<0.35){ spawnLaunchTrail(cx,cy,1,0.6,6); }
    }, 300);}catch(err){console.error('startFireballEffect',err);} }
function stopFireballEffect(){try{if(fireballEffectId){clearInterval(fireballEffectId);fireballEffectId=null;}}catch(e){}} 
function spawnBurnParticle(x,y,big=false){ if(!isFinite(x) || !isFinite(y)) return; let p=document.createElement('div');p.className='particle burn'; let size = big ? (12 + Math.random()*6) : 8; p.style.width = size+'px'; p.style.height = size+'px'; p.style.left=(x + (Math.random()-0.5)*8)+'px';p.style.top=(y + (Math.random()-0.5)*8)+'px';p.style.borderRadius='50%';p.style.opacity=1; p.style.background='radial-gradient(circle at 30% 30%, #fff3e0, #ff9800 30%, #d84315 70%)'; // biased diagonal: always down-right-ish
  let tx = (Math.random()-0.5)*30; let ty = -(20 + Math.random()*80); p.style.setProperty('--tx', tx+'px'); p.style.setProperty('--ty', ty+'px'); document.body.appendChild(p); setTimeout(()=>{ try{ if(p.parentNode) p.remove(); }catch(_e){} }, 1200); }

// Spawn a directional launch trail (as if the ball was thrown) from center with direction vector (dx,dy)
function spawnLaunchTrail(x,y,dx,dy,n=8){ if(!isFinite(x) || !isFinite(y)) return; try{let norm=Math.sqrt(dx*dx+dy*dy)||1;let ux=dx/norm, uy=dy/norm; for(let i=0;i<n;i++){let p=document.createElement('div');p.className='particle trail'; // rotation to align with direction
    let angle = Math.atan2(uy,ux) * 180/Math.PI; p.style.transform = `rotate(${angle}deg)`;
    p.style.left=(x + (Math.random()-0.5)*10)+'px'; p.style.top=(y + (Math.random()-0.5)*10)+'px'; let dist = 80 + Math.random()*100; let tx = ux*dist; let ty = uy*dist; p.style.setProperty('--tx', tx+'px'); p.style.setProperty('--ty', ty+'px'); document.body.appendChild(p); setTimeout(()=>{ try{ if(p.parentNode) p.remove(); }catch(_e){} }, 950);} }catch(e){console.error('spawnLaunchTrail',e);} }

function spawnAbsorbParticles(n,x,y){try{const el = document.getElementById('clickIcon'); if(!el) return; if(!isFinite(x) || !isFinite(y)) return; const r = el.getBoundingClientRect(); const cx = r.left + r.width/2; const cy = r.top + r.height/2; for(let i=0;i<n;i++){let p=document.createElement('div');p.className='particle absorb'; let size = 8 + Math.random()*6; p.style.width = size+'px'; p.style.height = size+'px'; p.style.left=(x + (Math.random()-0.5)*30)+'px'; p.style.top=(y + (Math.random()-0.5)*30)+'px'; // vector to center
    let dx = cx - (x + (Math.random()-0.5)*30); let dy = cy - (y + (Math.random()-0.5)*30); // bias and shrink
    let dist = Math.sqrt(dx*dx+dy*dy)||1; let tx = (dx/dist) * (60 + Math.random()*160); let ty = (dy/dist) * (60 + Math.random()*160); p.style.setProperty('--tx', tx+'px'); p.style.setProperty('--ty', ty+'px'); p.style.boxShadow = '0 0 8px rgba(0,0,0,0.5)'; document.body.appendChild(p); setTimeout(()=>{ try{ if(p.parentNode) p.remove(); }catch(_e){} }, 1000);} }catch(e){console.error('spawnAbsorbParticles',e);} }



function equipSkin(id){selectedSkin=id;applySkin(); if(selectedSkin==='fireball'){ startFireballEffect(); } else { stopFireballEffect(); } renderSkinsTab(); showPopup('Skin equipada');}

function buySkin(id,btn){let s=skins.find(x=>x.id===id);if(!s)return;if(puntos>=s.cost){puntos-=s.cost;ownedSkins.push(id);update();btn.classList.add('success');setTimeout(()=>{btn.classList.remove('success');renderSkinsTab();renderStore();},1000);}else{btn.classList.add('fail');showPopup('Fondos insuficientes');setTimeout(()=>{btn.classList.remove('fail');},1000);}}



// ===================== POPUPS =====================
function showPopup(text){const container = document.getElementById("popupContainer"); if(!container) return; // avoid duplicate identical popups (e.g., multiple 'Fondos insuficientes')
  if(Array.from(container.children).some(ch=>ch.textContent===text)) return; // enforce max 3 popups
  while(container.children.length >= 3){ const oldest = container.children[0]; oldest.classList.remove('show'); setTimeout(()=>{ if(oldest.parentNode) oldest.remove(); }, 350); }
  let popup=document.createElement("div");popup.className="popup";popup.textContent=text;container.appendChild(popup);requestAnimationFrame(()=>popup.classList.add('show'));setTimeout(()=>{popup.classList.remove('show');setTimeout(()=>popup.remove(),350);},2000); }

// calendar styles moved into the <style> block to avoid script parse errors

// ===================== NIVEL =====================
function checkLevel(){let leveled=false;while(nivel<xpTarget.length && experiencia>=xpTarget[nivel]){nivel++;showPopup("¬°Nivel "+nivel+"!");leveled=true;}if(leveled)updateLevel();}
function updateLevel(){document.getElementById("levelNum").textContent=nivel; if(nivel<xpTarget.length){ let base = xpTarget[nivel-1]; let next = xpTarget[nivel]; let cur = Math.max(0, experiencia - base); let needed = next - base; let pct = Math.min(100, Math.max(0, (cur/needed)*100)); document.getElementById("expBar").style.width = pct+"%"; document.getElementById("expText").textContent = `XP: ${cur} / ${needed}`; } else { document.getElementById("expBar").style.width = "100%"; document.getElementById("expText").textContent = `XP: ${experiencia} (MAX)`; } }

// ===================== AUTO CLIC + PLAY TIME =====================
setInterval(()=>{puntos+=autoClicks*multiplicadorTemporal;experiencia+=autoClicks*multiplicadorTemporal*xpMult;playTimeSeconds++; // increment play time
    // unlock time-based skins
    let unlockedAny=false;skins.forEach(s=>{if(s.unlock && s.unlock.playTime && playTimeSeconds>=s.unlock.playTime && !ownedSkins.includes(s.id)){ownedSkins.push(s.id);showPopup('Skin desbloqueada: '+s.name);unlockedAny=true;}});
    if(unlockedAny) renderSkinsTab();
    update();checkLevel();},1000);

// Autosave to localStorage every 30s (silent)
setInterval(()=>{try{let purchasedItems = storeItems.filter(it=>it.purchased).map(it=>it.id);let payload={puntos,incremento,autoClicks,multiplicadorTemporal,nivel,experiencia,xpMult,critChance,ownedSkins,selectedSkin,playTimeSeconds,consecutiveClicks,purchasedItems,dailyState,saveFormat:'dopamina'};localStorage.setItem('dopamina_autosave',JSON.stringify(payload));}catch(_e){}},30000);

// Load from local button
const _loadLocalBtn = document.getElementById('loadLocalBtn'); if(_loadLocalBtn) { _loadLocalBtn.onclick = ()=>{const s = localStorage.getItem('dopamina_autosave'); if(!s){ showPopup('No hay guardado local'); return; } try{ const data = JSON.parse(s); loadFromObject(data,'guardado local'); }catch(err){console.error(err); showPopup('Guardado local inv√°lido'); } } }

// ===================== DOPA ORB =====================


// ===================== DISCLAIMER + LOADER (moved earlier) =====================
// Global error handlers to surface runtime errors and avoid silent failures
window.addEventListener('error', e=>{console.error('Runtime error',e.error||e.message); try{showPopup('Error en ejecuci√≥n ‚Äî mira la consola'); }catch(_){}});
window.addEventListener('unhandledrejection', e=>{console.error('Unhandled rejection',e); try{showPopup('Error en promesa no gestionada'); }catch(_){}});

// ===================== SETTINGS =====================
document.getElementById("settingsIcon").onclick=()=>document.getElementById("settingsModal").style.display="flex";
document.getElementById("closeSettingsBtn").onclick=()=>document.getElementById("settingsModal").style.display="none";

// Skins button opens the Skins tab (defensive bindings)
const openSkins = ()=>{tabs.forEach(t=>{let el=document.getElementById(t);if(el)el.style.display='none';});const skinsTabEl = document.getElementById('skinsTab'); if(skinsTabEl) skinsTabEl.style.display='block';document.getElementById('tabLabel').textContent='Skins';document.getElementById('stats').classList.remove('gameTab');renderSkinsTab();};
const _settingsModalEl = document.getElementById('settingsModal');
const _settingsIconEl = document.getElementById('settingsIcon');
const _skinsBtnEl = document.getElementById('skinsBtn');
if(_settingsIconEl) _settingsIconEl.onclick = ()=>{ if(_settingsModalEl) _settingsModalEl.style.display='flex'; else showPopup('No se pudo abrir Ajustes'); };
if(_skinsBtnEl) _skinsBtnEl.onclick = ()=>openSkins();
// Ensure close button hides modal
const _closeSettingsBtnEl = document.getElementById('closeSettingsBtn'); if(_closeSettingsBtnEl) _closeSettingsBtnEl.onclick = ()=>{ if(_settingsModalEl) _settingsModalEl.style.display='none'; };
// Fallback: delegated click listener to handle cases where element handlers fail
if(!document._globalClickDelegated){ document.addEventListener('click', e=>{ try{ if(e.target && e.target.closest('#settingsIcon')){ if(_settingsModalEl) _settingsModalEl.style.display='flex'; else showPopup('No se pudo abrir Ajustes'); } if(e.target && e.target.closest('#skinsBtn')){ openSkins(); } }catch(err){console.error('Delegated click error',err);} }); document._globalClickDelegated=true; }

// ===================== CALENDARIO DIARIO =====================
let dailyState = { lastClaimISO: null, streak: 0, claimedDates: [] };
function isoDate(d){ const D = new Date(d); return D.toISOString().slice(0,10); }
function hasClaimed(iso){ return dailyState.claimedDates.indexOf(iso) !== -1; }
function renderDailyCalendar(){ const el = document.getElementById('dailyCalendar'); if(!el) return; const grid = document.getElementById('calendarGrid'); const streakEl = document.getElementById('calendarStreak'); streakEl.textContent = dailyState.streak || 0; grid.innerHTML = ''; const now = new Date(); const year = now.getFullYear(); const month = now.getMonth(); const days = new Date(year, month+1, 0).getDate(); for(let d=1; d<=days; d++){ let dt = new Date(year, month, d); let iso = isoDate(dt); let cell = document.createElement('div'); cell.className='dayCell'; if(iso===isoDate(now)) cell.classList.add('today'); if(hasClaimed(iso)) cell.classList.add('claimed'); cell.textContent = d; grid.appendChild(cell); }
  const claimBtn = document.getElementById('claimTodayBtn'); if(hasClaimed(isoDate(now))){ claimBtn.disabled=true; claimBtn.textContent='Ya reclamado'; } else { claimBtn.disabled=false; claimBtn.textContent='Reclamar hoy'; } }

const _openCalBtn = document.getElementById('dailyCalendarBtn'); if(_openCalBtn) _openCalBtn.onclick = ()=>{ const el = document.getElementById('dailyCalendar'); if(!el) return; el.style.display = el.style.display==='block' ? 'none' : 'block'; renderDailyCalendar(); };
const _claimBtn = document.getElementById('claimTodayBtn'); if(_claimBtn) _claimBtn.onclick = ()=>{ const now = new Date(); const todayISO = isoDate(now); if(hasClaimed(todayISO)){ showPopup('Ya reclamado hoy'); return; } const yesterday = new Date(now); yesterday.setDate(now.getDate()-1); const yesterdayISO = isoDate(yesterday); if(hasClaimed(yesterdayISO)){ dailyState.streak = (dailyState.streak||0) + 1; } else { dailyState.streak = 1; }
  dailyState.claimedDates.push(todayISO); dailyState.lastClaimISO = todayISO; const base = 50; const points = base + (dailyState.streak-1)*25; puntos += points; // reward multiplier on week streaks
  if(dailyState.streak % 7 === 0){ const boost = 2; multiplicadorTemporal *= boost; setTimeout(()=>{ multiplicadorTemporal = Math.max(1, multiplicadorTemporal/boost); }, 5*60*1000); showPopup('Recompensa: +'+points+' puntos y x'+boost+' por 5m por racha de '+dailyState.streak); } else { showPopup('Recompensa: +'+points+' puntos (racha: '+dailyState.streak+')'); }
// Animations: button fire, sparks, button pulse, today's cell pop, streak pulse + confetti
  try{ const calBtn = document.getElementById('dailyCalendarBtn'); if(calBtn){ calBtn.classList.add('fireAnim'); setTimeout(()=>calBtn.classList.remove('fireAnim'),1200); spawnFireSparks(calBtn,12); }
    _claimBtn.classList.add('claimedAnim'); setTimeout(()=>_claimBtn.classList.remove('claimedAnim'),900); const grid = document.getElementById('calendarGrid'); const todayCell = grid ? grid.querySelector('.today') : null; if(todayCell){ todayCell.classList.add('claimedAnim'); setTimeout(()=>todayCell.classList.remove('claimedAnim'),900); }
    const streakEl = document.getElementById('calendarStreak'); if(streakEl){ streakEl.classList.add('streakPulse'); setTimeout(()=>streakEl.classList.remove('streakPulse'),800); }
    spawnCalendarConfetti(document.getElementById('dailyCalendar'),14);
  }catch(_e){}
  renderDailyCalendar(); update(); }

function spawnCalendarConfetti(container, n=12){ try{ if(!container) return; for(let i=0;i<n;i++){ const c = document.createElement('div'); c.className='confetti'; const colors = ['#ffeb3b','#ff4081','#ff7043','#66bb6a','#29b6f6']; c.style.background = colors[Math.floor(Math.random()*colors.length)]; c.style.left = (8 + Math.random()*(container.clientWidth-16))+'px'; c.style.top = (8 + Math.random()*20)+'px'; c.style.width = (6 + Math.random()*6)+'px'; c.style.height = (6 + Math.random()*6)+'px'; container.appendChild(c); (function(el){ setTimeout(()=>{ try{ if(el.parentNode) el.remove(); }catch(_e){} }, 1100); })(c); } }catch(e){console.error('spawnCalendarConfetti',e);} }

function spawnFireSparks(container,n=8){ try{ if(!container) return; for(let i=0;i<n;i++){ const s = document.createElement('div'); s.className='spark'; const colors = ['#ffeb3b','#ff9800','#ff7043']; s.style.background = colors[Math.floor(Math.random()*colors.length)]; s.style.left = (8 + Math.random()*(container.clientWidth-16))+'px'; s.style.top = (container.clientHeight - 14 + Math.random()*8)+'px'; s.style.width = (3 + Math.random()*4)+'px'; s.style.height = (8 + Math.random()*8)+'px'; container.appendChild(s); (function(el){ setTimeout(()=>{ try{ if(el.parentNode) el.remove(); }catch(_e){} }, 900); })(s); } }catch(e){console.error('spawnFireSparks',e);} }

// End Calendario Diario


function startDeformer(){try{const d=document.querySelector('.deformer');if(!d) return; if(deformerIntervalId) try{clearInterval(deformerIntervalId);}catch(_i){}; const trigger=()=>{d.classList.add('play'); setTimeout(()=>d.classList.remove('play'),1000);} ; trigger(); deformerIntervalId = setInterval(()=>{trigger();},3000+Math.floor(Math.random()*4000));}catch(err){console.error('startDeformer error',err);} }

function formatDuration(sec){if(sec<=0) return '0s';let h=Math.floor(sec/3600);let m=Math.floor((sec%3600)/60);let s=sec%60; if(h>0) return `${h}h ${m}m`; if(m>0) return `${m}m ${s}s`; return `${s}s`;}

function renderSkinsTab(){// clear any previous skins-timer
  if(skinsTimerIntervalId) { clearInterval(skinsTimerIntervalId); skinsTimerIntervalId = null; }
  let idx=document.getElementById('skinsIndex');let detail=document.getElementById('skinDetail');if(!idx||!detail)return;idx.innerHTML='';detail.innerHTML='<p>Selecciona una skin para ver detalles.</p>';
  skins.forEach(s=>{let box=document.createElement('div');box.className='skinIndexBox';
    let preview=document.createElement('div');preview.className='previewInner';
    // ensure preview is a circle and not stretched
    preview.style.width='120px'; preview.style.height='120px'; preview.style.borderRadius='50%'; preview.style.background=s.style.background;preview.style.border=s.style.border||'none';preview.style.backgroundSize='cover';preview.style.backgroundPosition='center';preview.style.cursor='none';preview.style.flexShrink='0';
    let label=document.createElement('div');label.textContent=s.name;label.style.fontSize='13px';label.style.marginTop='8px';label.style.textAlign='center';box.appendChild(preview);box.appendChild(label);box.title=s.name;
    // clicking index preview opens detail and spawns particles
    preview.onclick=(ev)=>{ev.stopPropagation(); box.onclick(); const r = preview.getBoundingClientRect(); let cx = r.left + r.width/2; let cy = r.top + r.height/2; if(!isFinite(cx) || !isFinite(cy) || r.width < 6 || r.height < 6){ // fallback to parent center
        const pr = preview.parentElement ? preview.parentElement.getBoundingClientRect() : document.body.getBoundingClientRect(); cx = pr.left + pr.width/2; cy = pr.top + pr.height/2; }
      if(s.id==='fireball') spawnFireParticles(14,cx,cy); else spawnSkinParticles(s,cx,cy,12); };

    box.onclick=()=>{detail.innerHTML='';let previewBig=document.createElement('div');previewBig.className='skinDetailPreview';previewBig.style.background=s.style.background;previewBig.style.border=s.style.border||'none';previewBig.style.backgroundSize='cover';previewBig.style.backgroundPosition='center';previewBig.style.boxShadow=s.style.boxShadow||'0 0 30px rgba(0,0,0,0.6)';previewBig.style.cursor='none';
      let name=document.createElement('div');name.textContent=s.name;name.style.fontWeight='bold';let desc=document.createElement('div');desc.textContent=s.desc;desc.style.marginTop='8px';
    // decide locked/unlocked
    const locked = !!(s.unlock && s.unlock.playTime && playTimeSeconds < s.unlock.playTime);
    let btn=document.createElement('button');btn.className='buyBtn';
    if(locked){btn.textContent=`Bloqueada (${formatDuration(s.unlock.playTime - playTimeSeconds)})`;btn.disabled=true;btn.classList.add('locked');btn.dataset.locked='1';btn.dataset.unlockAt=s.unlock.playTime;}
    else if(ownedSkins.includes(s.id)){
      if(selectedSkin===s.id){btn.textContent='Equipado';btn.disabled=true;btn.style.opacity=0.8;}else{btn.textContent='Equipar';btn.onclick=()=>{equipSkin(s.id);detail.innerHTML='';renderSkinsTab();}}
    } else {btn.textContent=`Comprar (${s.cost})`;btn.onclick=(e)=>{ e.stopPropagation(); btn.dataset.handled='1'; setTimeout(()=>{ try{ delete btn.dataset.handled; }catch(_e){} },1100); buySkin(s.id,btn); detail.innerHTML=''; renderSkinsTab(); }};
    // allow clicking previewBig to act like the button
    previewBig.onclick=()=>{ if(btn && typeof btn.click === 'function') btn.click(); const r=previewBig.getBoundingClientRect(); const cx=r.left + r.width/2; const cy=r.top + r.height/2; if(s.id==='fireball') spawnFireParticles(18,cx,cy); else spawnSkinParticles(s,cx,cy,16); };

    detail.appendChild(previewBig);detail.appendChild(name);detail.appendChild(desc);detail.appendChild(btn);document.querySelectorAll('.skinIndexBox').forEach(b=>b.classList.remove('selected'));box.classList.add('selected');};idx.appendChild(box);});
  // Add 'Proximamente' box matching other boxes
  let moreBox=document.createElement('div');moreBox.className='skinIndexBox';let morePreview=document.createElement('div');morePreview.className='previewInner comingSoon';morePreview.style.width='120px';morePreview.style.height='120px';morePreview.style.display='flex';morePreview.style.justifyContent='center';morePreview.style.alignItems='center';let inner=document.createElement('div');inner.className='deformer';morePreview.appendChild(inner);let label2=document.createElement('div');label2.textContent='Pr√≥ximamente';label2.style.fontSize='12px';label2.style.marginTop='8px';moreBox.appendChild(morePreview);moreBox.appendChild(label2);idx.appendChild(moreBox);startDeformer();

  // Setup a per-second updater while skins tab visible to refresh lock timers
  skinsTimerIntervalId = setInterval(()=>{
    const skinsTab = document.getElementById('skinsTab'); if(!skinsTab || skinsTab.style.display!=='block') return; const lockedBtns = document.querySelectorAll('#skinsIndex .buyBtn[data-locked="1"]'); if(lockedBtns.length===0) { clearInterval(skinsTimerIntervalId); skinsTimerIntervalId=null; return; }
    lockedBtns.forEach(btn=>{ const unlockAt = Number(btn.dataset.unlockAt)||0; const remaining = Math.max(0, unlockAt - playTimeSeconds); if(remaining<=0){ renderSkinsTab(); } else { btn.textContent = `Bloqueada (${formatDuration(remaining)})`; } }); },1000);
}

// spawn skin particles (non-fireball fallback)
function spawnSkinParticles(s,x,y,n=12){ if(!isFinite(x) || !isFinite(y)) return; for(let i=0;i<n;i++){let p=document.createElement('div');p.className='particle';p.style.left=(x + (Math.random()-0.5)*80)+"px";p.style.top=(y + (Math.random()-0.5)*80)+"px";p.style.width="10px";p.style.height="10px";p.style.borderRadius="50%";p.style.opacity=1; p.style.background = (s && s.style && s.style.background) ? s.style.background : `hsl(${Math.random()*360},100%,60%)`; let tx=(Math.random()-0.5)*30; let ty = (Math.random()-0.5)*30; // gentle spread
    p.style.setProperty("--tx",tx+"px");p.style.setProperty("--ty",ty+"px"); document.body.appendChild(p); setTimeout(()=>{try{p.remove()}catch(_e){}},800);} } 
document.getElementById("performanceToggle").onchange=e=>{performanceMode=e.target.checked;}
document.getElementById("loadSaveBtn").onclick=()=>document.getElementById("loadSaveInput").click();
function loadFromObject(data, srcLabel='archivo'){try{if(typeof data.puntos==='undefined' || typeof data.incremento==='undefined'){showPopup('Archivo de guardado inv√°lido');return false;} // assign expected fields onto window
    // back-compat: if loaded from older save that didn't have saveFormat, treat as old
    if(!data.saveFormat){ /* missing saveFormat indicates legacy file */ }

    if(typeof data.puntos!=='undefined') puntos = Number(data.puntos) || 0; if(typeof data.incremento!=='undefined') incremento = Number(data.incremento) || 1; if(typeof data.autoClicks!=='undefined') autoClicks = Number(data.autoClicks) || 0; if(typeof data.multiplicadorTemporal!=='undefined') multiplicadorTemporal = Number(data.multiplicadorTemporal) || 1; if(typeof data.nivel!=='undefined') nivel = Number(data.nivel) || 1; if(typeof data.experiencia!=='undefined') experiencia = Number(data.experiencia) || 0; if(typeof data.xpMult!=='undefined') xpMult = Number(data.xpMult) || 1; if(typeof data.critChance !== 'undefined') critChance = data.critChance || 0; if(typeof data.ownedSkins !== 'undefined') ownedSkins = Array.isArray(data.ownedSkins) ? data.ownedSkins : ownedSkins; if(typeof data.skins !== 'undefined' && !data.ownedSkins) ownedSkins = Array.isArray(data.skins) ? data.skins : ownedSkins; if(typeof data.selectedSkin !== 'undefined') selectedSkin = data.selectedSkin; if(typeof data.skin !== 'undefined' && !data.selectedSkin) selectedSkin = data.skin; if(typeof data.playTimeSeconds !== 'undefined') playTimeSeconds = Number(data.playTimeSeconds) || 0; if(typeof data.consecutiveClicks !== 'undefined') consecutiveClicks = Number(data.consecutiveClicks) || 0; // restore purchased items
    if(typeof data.purchasedItems !== 'undefined' && Array.isArray(data.purchasedItems)){ storeItems.forEach(it=>{ it.purchased = data.purchasedItems.includes(it.id); }); // apply one-time effects for purchased items (defensive: ensure things like critChance are set)
      storeItems.forEach(it=>{ if(it.purchased && typeof it.func === 'function' && it.once){ try{ it.func(); }catch(_e){} } }); }else if(typeof data.purchased !== 'undefined' && Array.isArray(data.purchased)){ storeItems.forEach(it=>{ it.purchased = data.purchased.includes(it.id); }); }
    // restore daily calendar state if present
    if(typeof data.dailyState !== 'undefined' && typeof data.dailyState === 'object'){ dailyState = { lastClaimISO: data.dailyState.lastClaimISO || null, streak: Number(data.dailyState.streak) || 0, claimedDates: Array.isArray(data.dailyState.claimedDates) ? data.dailyState.claimedDates : [] }; } else if(typeof data.claimedDates !== 'undefined' && Array.isArray(data.claimedDates)){ dailyState = { lastClaimISO: data.lastClaimISO || null, streak: Number(data.streak) || 0, claimedDates: data.claimedDates }; }
    // mark save format if present
    if(typeof data.saveFormat !== 'undefined'){
      // nothing to do, preserved
    }
  
    update();renderStore();renderSkinsTab();applySkin(); if(selectedSkin==='fireball'){ startFireballEffect(); } else { stopFireballEffect(); } showPopup('Guardado cargado desde '+srcLabel);return true;}catch(err){console.error('loadFromObject',err);showPopup('Error al leer el archivo');return false;}}

// Try to migrate legacy save payloads into the current dopamina format
function migrateSave(old){ try{
        const data = Object.assign({}, old);
        // Basic numeric normalization with defaults
        data.puntos = Number(data.puntos) || 0;
        data.incremento = Number(data.incremento) || 1;
        data.autoClicks = Number(data.autoClicks) || 0;
        data.multiplicadorTemporal = Number(data.multiplicadorTemporal) || 1;
        data.nivel = Number(data.nivel) || 1;
        data.experiencia = Number(data.experiencia) || 0;
        data.xpMult = Number(data.xpMult) || 1;
        data.critChance = (typeof data.critChance !== 'undefined') ? Number(data.critChance) : 0;
        // Skins normalization
        if(!data.ownedSkins){ if(Array.isArray(data.skins)) data.ownedSkins = data.skins; else data.ownedSkins = ['default']; }
        if(!data.selectedSkin){ if(data.skin) data.selectedSkin = data.skin; else data.selectedSkin = data.ownedSkins && data.ownedSkins[0] ? data.ownedSkins[0] : 'default'; }
        // Purchased items normalization
        if(!data.purchasedItems){ if(Array.isArray(data.purchased)) data.purchasedItems = data.purchased; else if(typeof data.purchases === 'object'){ data.purchasedItems = Object.keys(data.purchases).filter(k=>data.purchases[k]); } else data.purchasedItems = []; }
        // Daily calendar state
        if(!data.dailyState){ if(Array.isArray(data.claimedDates) || data.lastClaimISO || data.streak){ data.dailyState = { lastClaimISO: data.lastClaimISO || null, streak: Number(data.streak) || 0, claimedDates: Array.isArray(data.claimedDates)?data.claimedDates:[] }; } else { data.dailyState = { lastClaimISO: null, streak:0, claimedDates:[] }; } }
        // Ensure saveFormat is present so future loads are treated as current
        data.saveFormat = 'dopamina';
        console.warn('Migrated legacy save to dopamina format');
        return data; }catch(e){ console.error('migrateSave error',e); return old; } }

document.getElementById("loadSaveInput").onchange=e=>{let file=e.target.files[0];if(!file)return; if(!file.name.endsWith('.dopamina') && !file.name.endsWith('.json')){ showPopup('Formato no v√°lido (.dopamina)'); return; } let reader=new FileReader();reader.onload=f=>{try{let data=JSON.parse(f.target.result);let wasOld = false; // if file name is old-style .json, or payload is missing saveFormat, attempt migration
            if(file.name.endsWith('.json') || !data.saveFormat){ try{ data = migrateSave(data); wasOld = true; window.loadedFromOldFormat = true; const hint = document.getElementById('legacySaveHint'); if(hint) hint.style.display='block'; }catch(_e){ console.warn('migration failed',_e); } }
        const ok = loadFromObject(data, wasOld? 'archivo (migrado)': 'archivo'); if(ok && wasOld){ showPopup('¬°Has cargado un archivo antiguo! Cambia a .dopamina para seguir guardando cosas'); }
    }catch(err){console.error(err);showPopup('Error al leer el archivo');}};reader.readAsText(file);} 
document.getElementById("downloadSaveBtn").onclick=()=>{let purchasedItems = storeItems.filter(it=>it.purchased).map(it=>it.id);let payload={puntos,incremento,autoClicks,multiplicadorTemporal,nivel,experiencia,xpMult,critChance,ownedSkins,selectedSkin,playTimeSeconds,consecutiveClicks,purchasedItems,dailyState,saveFormat:'dopamina'};let data=JSON.stringify(payload);try{localStorage.setItem('dopamina_autosave',data);}catch(_e){}let blob=new Blob([data],{type:"application/json"});let a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="dopamina_save.dopamina";a.click();showPopup('Guardado descargado y guardado localmente'); // hide legacy hint once user re-saves in new format
  loadedFromOldFormat = false; const legacyHint = document.getElementById('legacySaveHint'); if(legacyHint) legacyHint.style.display='none';} 

// ===================== CUSTOM CURSOR =====================
(function(){try{const cursor = document.getElementById('customCursor'); if(!cursor) return; let ox=0, oy=0; document.addEventListener('mousemove', e=>{ const x=e.clientX, y=e.clientY; cursor.style.left = x+'px'; cursor.style.top = y+'px'; }); document.addEventListener('mousedown', e=>{ try{ if(!cursor) return; // clear previous timeouts if present
    if(cursor._contractTO){ clearTimeout(cursor._contractTO); cursor._contractTO = null; }
    if(cursor._sparkTO){ clearTimeout(cursor._sparkTO); cursor._sparkTO = null; }
    // only start a new contract if not currently contracting (prevents stacking)
    if(!cursor.classList.contains('contract')){
      cursor.classList.add('contract');
      cursor._contractTO = setTimeout(()=>{ try{ cursor.classList.remove('contract'); cursor._contractTO = null; }catch(_e){} }, 260);
    }
    // spark effect can be retriggered but timer is guarded
    cursor.classList.add('spark');
    cursor._sparkTO = setTimeout(()=>{ try{ cursor.classList.remove('spark'); cursor._sparkTO = null; }catch(_e){} }, 300);
  }catch(err){console.error('cursor mousedown',err);} });

// also support touchstart (mobile) with same protection
document.addEventListener('touchstart', e=>{ try{ if(!cursor) return; if(cursor._contractTO){ clearTimeout(cursor._contractTO); cursor._contractTO = null; } if(cursor._sparkTO){ clearTimeout(cursor._sparkTO); cursor._sparkTO = null; } if(!cursor.classList.contains('contract')){ cursor.classList.add('contract'); cursor._contractTO = setTimeout(()=>{ try{ cursor.classList.remove('contract'); cursor._contractTO = null; }catch(_e){} }, 260); } cursor.classList.add('spark'); cursor._sparkTO = setTimeout(()=>{ try{ cursor.classList.remove('spark'); cursor._sparkTO = null; }catch(_e){} }, 300); }catch(err){console.error('cursor touchstart',err);} }, {passive:true}); }catch(err){console.error('cursor init',err);} })(); 
</script>
</body>
</html>